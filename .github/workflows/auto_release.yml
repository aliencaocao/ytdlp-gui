name: Auto Release

on:
  schedule:
    - cron: '0 */6 * * *'  # Check every 6 hours
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  check_update:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
    - name: Check for new yt-dlp release
      id: check
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get latest yt-dlp release tag (e.g., 2026.02.04)
        UPSTREAM_TAG=$(gh api repos/yt-dlp/yt-dlp/releases/latest --jq '.tag_name')
        echo "Upstream yt-dlp version: $UPSTREAM_TAG"

        # Remove leading zeros after dots: 2026.02.04 -> 2026.2.4
        NEW_VERSION=$(echo "$UPSTREAM_TAG" | sed 's/\.0\([0-9]\)/.\1/g')
        echo "Converted version: $NEW_VERSION"

        # Get our latest release tag
        OUR_TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name' 2>/dev/null || echo "none")
        echo "Our latest version: $OUR_TAG"

        if [ "$NEW_VERSION" != "$OUR_TAG" ]; then
          echo "New version detected!"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "should_release=true" >> "$GITHUB_OUTPUT"
        else
          echo "Already up to date."
          echo "should_release=false" >> "$GITHUB_OUTPUT"
        fi

  build_windows:
    needs: check_update
    if: needs.check_update.outputs.should_release == 'true'
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v6
    - name: Update version.yml
      shell: bash
      run: sed -i "s/^Version: .*/Version: ${{ needs.check_update.outputs.new_version }}/" version.yml
    - uses: actions/setup-python@v6
      with:
        python-version: '3.14'
        check-latest: true
    - run: pip install pyinstaller-versionfile
    - name: Install UPX
      uses: crazy-max/ghaction-upx@v3
      with:
        install-only: true
    - name: Check UPX version
      run: upx --version
    - name: Download FFMPEG binaries
      run: |
        C:\msys64\usr\bin\wget.exe https://github.com/yt-dlp/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip
        7z x ffmpeg-master-latest-win64-gpl.zip
        cp ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe .
        cp ffmpeg-master-latest-win64-gpl/bin/ffprobe.exe .
        ./ffmpeg -version
    - name: Download Deno
      run: |
        C:\msys64\usr\bin\wget.exe https://github.com/denoland/deno/releases/latest/download/deno-x86_64-pc-windows-msvc.zip
        7z x deno-x86_64-pc-windows-msvc.zip
        ./deno --version
    - name: Create version.txt for PyInstaller
      run: create-version-file version.yml --outfile version.txt
    - name: PyInstaller Windows
      uses: aliencaocao/pyinstaller_action@main
      with:
        python_ver: '3.14'
        spec: 'yt-dlp-gui.spec'
        requirements: 'requirements.txt'
        upload_exe_with_name: 'yt-dlp-gui.exe'
        clean_checkout: false

  build_linux:
    needs: check_update
    if: needs.check_update.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: actions/setup-python@v6
      with:
        python-version: '3.14'
        check-latest: true
    - name: Install UPX
      uses: crazy-max/ghaction-upx@v3
      with:
        install-only: true
    - name: Check UPX version
      run: upx --version
    - name: Download Deno
      run: |
        wget https://github.com/denoland/deno/releases/latest/download/deno-x86_64-unknown-linux-gnu.zip
        unzip deno-x86_64-unknown-linux-gnu.zip
        chmod +x deno
        ./deno --version
    - name: PyInstaller Linux
      uses: aliencaocao/pyinstaller_action@main
      with:
        python_ver: '3.14'
        spec: 'yt-dlp-gui-linux.spec'
        requirements: 'requirements.txt'
        upload_exe_with_name: 'yt-dlp-gui'
        clean_checkout: false

  release:
    needs: [check_update, build_windows, build_linux]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Update version.yml and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        sed -i "s/^Version: .*/Version: ${{ needs.check_update.outputs.new_version }}/" version.yml
        git add version.yml
        git commit -m "Bump yt-dlp to ${{ needs.check_update.outputs.new_version }}"
        git push
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        merge-multiple: true
    - name: Create Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh release create "${{ needs.check_update.outputs.new_version }}" \
          --title "${{ needs.check_update.outputs.new_version }}" \
          --generate-notes \
          artifacts/*
